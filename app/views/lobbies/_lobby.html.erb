<div class="app-container">
    <%= render 'shared/navbar' %>

    <main class="main-content">
        <div id="lobbiesPage" class="page">
            <div class="page-header align">
                <div>
                    <h1 class="page-title"><%= lobby.name.presence || 'UNNAMED LOBBY' %></h1>
                    <p class="page-subtitle">
                        Host: <%= lobby.owner.full_name %> | Visibility: <%= lobby.private? ? 'Private' : 'Public' %>
                    </p>
                </div>
            </div>

            <div class="content-area">
                <!-- Three Column Layout -->
                <div class="lobby-layout">
                    <!-- Left Column: Shared Notes -->
                    <div class="lobby-section">
                        <h3 class="section-title">Shared Notes</h3>
                        <div class="notes-area">
                            <textarea placeholder="Take shared notes here..." rows="10"></textarea>
                        </div>
                    </div>

                    <!-- Center Column: Shared Whiteboard -->
                    <div class="lobby-section whiteboard-section">
                        <h3 class="section-title">Shared Whiteboard</h3>
                        
                        <!-- SVG Canvas -->
                        <div class="whiteboard-canvas">
                            <% if lobby.whiteboard&.svg_data.present? %>
                                <%= lobby.whiteboard.svg_data.html_safe %>
                            <% else %>
                                <svg width="100%" height="300" viewBox="0 0 800 300" xmlns="http://www.w3.org/2000/svg" class="whiteboard-svg">
                                    <defs>
                                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#444" stroke-width="0.5" opacity="0.5"/>
                                        </pattern>
                                    </defs>
                                    <rect width="100%" height="100%" fill="url(#grid)"/>
                                    <!-- Coordinate helpers -->
                                    <text x="10" y="20" fill="#666" font-family="Arial" font-size="12" opacity="0.7">X: 0-800, Y: 0-300</text>
                                    <text x="400" y="150" text-anchor="middle" fill="#888" font-family="Arial" font-size="16" opacity="0.8">
                                        Collaborative Whiteboard - Use tools below to add content
                                    </text>
                                    <!-- Coordinate markers -->
                                    <circle cx="100" cy="50" r="2" fill="#666" opacity="0.5"/>
                                    <text x="105" y="55" fill="#666" font-size="10" opacity="0.7">100,50</text>
                                    <circle cx="400" cy="150" r="2" fill="#666" opacity="0.5"/>
                                    <text x="405" y="155" fill="#666" font-size="10" opacity="0.7">400,150</text>
                                    <circle cx="700" cy="250" r="2" fill="#666" opacity="0.5"/>
                                    <text x="705" y="255" fill="#666" font-size="10" opacity="0.7">700,250</text>
                                </svg>
                            <% end %>
                        </div>
                        
                        <!-- Whiteboard Tools -->
                        <div class="whiteboard-toolbar">
                            <!-- Custom Text Tool -->
                            <div class="tool-group">
                                <label class="tool-label">Add Custom Text:</label>
                                <div class="custom-text-form">
                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "text-form" do |f| %>
                                        <%= f.hidden_field :tool, value: "text" %>
                                        <div class="form-row">
                                            <%= f.text_field :text, placeholder: "Enter your text...", class: "text-input", value: "", required: true %>
                                        </div>
                                        <div class="form-row coordinates">
                                            <%= f.number_field :x, placeholder: "X position (0-800)", class: "coord-input", min: 0, max: 800, value: 400 %>
                                            <%= f.number_field :y, placeholder: "Y position (0-300)", class: "coord-input", min: 0, max: 300, value: 150 %>
                                        </div>
                                        <div class="form-row">
                                            <%= f.color_field :color, value: "#000000", class: "color-input" %>
                                            <%= f.submit "Add Text", class: "tool-btn primary" %>
                                        </div>
                                    <% end %>
                                </div>
                            </div>
                            
                            <!-- Quick Text Positions -->
                            <div class="tool-group">
                                <label class="tool-label">Quick Text Positions:</label>
                                <div class="tool-buttons">
                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                        <%= f.hidden_field :tool, value: "text" %>
                                        <%= f.hidden_field :x, value: 100 %>
                                        <%= f.hidden_field :y, value: 50 %>
                                        <%= f.hidden_field :text, value: "Top Left" %>
                                        <%= f.hidden_field :color, value: "#0066cc" %>
                                        <%= f.submit "ðŸ“ Top Left", class: "tool-btn text" %>
                                    <% end %>
                                    
                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                        <%= f.hidden_field :tool, value: "text" %>
                                        <%= f.hidden_field :x, value: 400 %>
                                        <%= f.hidden_field :y, value: 100 %>
                                        <%= f.hidden_field :text, value: "Center Top" %>
                                        <%= f.hidden_field :color, value: "#cc6600" %>
                                        <%= f.submit "ðŸ“ Center", class: "tool-btn text" %>
                                    <% end %>
                                    
                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                        <%= f.hidden_field :tool, value: "text" %>
                                        <%= f.hidden_field :x, value: 700 %>
                                        <%= f.hidden_field :y, value: 250 %>
                                        <%= f.hidden_field :text, value: "Bottom Right" %>
                                        <%= f.hidden_field :color, value: "#cc0066" %>
                                        <%= f.submit "ðŸ“ Bottom Right", class: "tool-btn text" %>
                                    <% end %>
                                </div>
                            </div>
                            
                            <!-- Quick Shape Tools -->
                            <div class="tool-group">
                                <label class="tool-label">Quick Shapes:</label>
                                <div class="tool-buttons">
                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                        <%= f.hidden_field :tool, value: "rectangle" %>
                                        <%= f.hidden_field :x, value: rand(50..400) %>
                                        <%= f.hidden_field :y, value: rand(40..180) %>
                                        <%= f.hidden_field :width, value: 80 %>
                                        <%= f.hidden_field :height, value: 50 %>
                                        <%= f.hidden_field :color, value: "#ffffff" %>
                                        <%= f.submit "â¬œ Rectangle", class: "tool-btn primary" %>
                                    <% end %>
                                    
                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                        <%= f.hidden_field :tool, value: "circle" %>
                                        <%= f.hidden_field :x, value: rand(80..500) %>
                                        <%= f.hidden_field :y, value: rand(60..200) %>
                                        <%= f.hidden_field :radius, value: 35 %>
                                        <%= f.hidden_field :color, value: "#44ff44" %>
                                        <%= f.submit "â­• Circle", class: "tool-btn primary" %>
                                    <% end %>
                                    
                                    <%= form_with url: clear_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                        <%= f.submit "ðŸ—‘ï¸ Clear", class: "tool-btn danger", 
                                            data: { confirm: "Clear the whiteboard?" } %>
                                    <% end %>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Participants -->
                    <div class="lobby-section">
                        <h3 class="section-title">Participants (<%= lobby.lobby_members.length %>)</h3>
                        <div class="participants-list">
                            <% if lobby.lobby_members.any? %>
                                <ul class="lobby-members">
                                    <% lobby.lobby_members.each do |member| %>
                                        <li class="participant-item">
                                            <div class="participant-avatar">
                                                <%= member.user.first_name.first.upcase %>
                                            </div>
                                            <span class="participant-name"><%= member.user.full_name %></span>
                                            <div class="participant-status">
                                                <span class="status-dot online" title="Online"></span>
                                            </div>
                                        </li>
                                    <% end %>
                                </ul>
                            <% end %>
                        </div>

                        <!-- Voice Chat Section -->
                        <div class="voice-chat-section">
                            <h4 class="section-title">Voice Chat</h4>
                            <div class="voice-controls">
                                <button class="voice-btn" id="mute-btn">ðŸŽ¤ Mute</button>
                                <button class="voice-btn" id="leave-btn">ðŸ“ž Leave</button>
                            </div>
                        </div>

                        <!-- Lobby Analytics -->
                        <div class="lobby-analytics">
                            <h4 class="section-title">Lobby Analytics</h4>
                            <div class="analytics-item">
                                <span>Session Duration:</span>
                                <span class="analytics-value">1h 30m</span>
                            </div>
                            <div class="analytics-item">
                                <span>Active Users:</span>
                                <span class="analytics-value"><%= lobby.lobby_members.length %>/5</span>
                            </div>
                            <div class="analytics-item">
                                <span>Problems Solved:</span>
                                <span class="analytics-value">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description and Permissions Section -->
                <div class="lobby-details">
                    <h3 class="section-title">Description</h3>
                    <div class="lobby-description"><%= lobby.description %></div>
                    
                    <% if current_user == lobby.owner %>
                        <div class="lobby-code-display">
                            <strong>Lobby Code:</strong> <span><%= lobby.lobby_code %></span>
                        </div>
                    <% end %>

                    <% if current_user == lobby.owner && lobby.lobby_members.length > 1 %>
                        <hr>
                        <h3 class="page-title">Manage Permissions</h3>

                        <%= form_with(model: lobby, url: update_all_lobby_permissions_path(lobby), method: :patch) do |form| %>
                            <table class="permissions-table">
                            <thead>
                                <tr>
                                <th>Participant</th>
                                <th>Can Draw</th>
                                <th>Can Edit Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% form.fields_for :lobby_members do |member_form| %>
                                <% next if member_form.object.user == lobby.owner %>
                                <tr>
                                    <td>
                                    <%= member_form.object.user.full_name %>
                                    <%= member_form.hidden_field :id %>
                                    </td>
                                    <td>
                                    <%= member_form.label :can_draw, "Can Draw", class: "visually-hidden" %>
                                    <%= member_form.check_box :can_draw %>
                                    </td>
                                    <td>
                                    <%= member_form.label :can_edit_notes, "Can Edit Notes", class: "visually-hidden" %>
                                    <%= member_form.check_box :can_edit_notes %>
                                    </td>
                                </tr>
                                <% end %>
                            </tbody>
                            </table>
                            <div class="lobby-actions">
                                <%= form.submit "Update All Permissions", class: "btn btn-primary" %>
                            </div>
                        <% end %>
                    <% end %>

                    <div class="lobby-actions">
                        <% if current_user == lobby.owner %>
                            <%= link_to "Destroy Lobby", lobby, 
                                        data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, 
                                        class: "btn btn-danger" %>
                        <% else %>
                            <%= button_to "Leave Lobby", leave_lobby_path(lobby), 
                                        method: :delete, 
                                        class: "btn btn-warning" %>
                        <% end %>
                        
                        <%= link_to "Back to Lobbies", lobbies_path, class: "btn btn-secondary" %>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>