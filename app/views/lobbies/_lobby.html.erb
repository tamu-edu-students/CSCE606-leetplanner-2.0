<div class="app-container">
    <%= render 'shared/navbar' %>

    <main class="main-content">
        <div id="lobbiesPage" class="page">
            <div class="page-header align">
                <div>
                    <h1 class="page-title"><%= lobby.name.presence || 'UNNAMED LOBBY' %></h1>
                    <p class="page-subtitle">
                        Host: <%= lobby.owner.full_name %> | Visibility: <%= lobby.private? ? 'Private' : 'Public' %>
                    </p>
                </div>
            </div>

            <div class="content-area">
                <!-- Three Column Layout -->
                <div class="lobby-layout">
                    <!-- Left Column: Shared Notes -->
                    <div class="lobby-section">
                        <h3 class="section-title">Shared Notes</h3>
                                                <div class="notes-area">
                                                        <% if lobby.whiteboard %>
                                                            <% editable_notes = (current_user == lobby.owner) || lobby.lobby_members.find_by(user: current_user)&.can_edit_notes %>
                                                            <% if editable_notes %>
                                                                <%= form_with model: lobby.whiteboard, url: update_notes_lobby_whiteboards_path(lobby), method: :patch, local: true do |f| %>
                                                                    <%= f.text_area :notes, rows: 10, placeholder: "Take shared notes here...", value: lobby.whiteboard.notes, class: "shared-notes" %>
                                                                    <div class="form-row">
                                                                        <%= f.submit "Save Notes", class: "btn btn-primary" %>
                                                                    </div>
                                                                <% end %>
                                                            <% else %>
                                                                <textarea rows="10" readonly placeholder="No notes yet"> <%= lobby.whiteboard.notes %></textarea>
                                                                <small>You don't have permission to edit notes.</small>
                                                            <% end %>
                                                        <% else %>
                                                            <em>Whiteboard not initialized.</em>
                                                        <% end %>
                                                </div>
                    </div>

                    <!-- Center Column: Shared Whiteboard -->
                    <div class="lobby-section whiteboard-section">
                        <h3 class="section-title">Shared Whiteboard</h3>
                        
                        <!-- Simple Whiteboard -->
                        <div class="whiteboard-container">
                            <!-- Toolbar -->
                            <div class="whiteboard-toolbar">
                                <button id="pen-tool" class="tool-btn active">‚úèÔ∏è Draw</button>
                                <button id="text-tool" class="tool-btn">üìù Text</button>
                                <button id="rect-tool" class="tool-btn">‚¨ú Rectangle</button>
                                <button id="circle-tool" class="tool-btn">‚≠ï Circle</button>
                                <button id="sticky-tool" class="tool-btn">üìå Sticky</button>
                                <button id="clear-btn" class="tool-btn danger">üóëÔ∏è Clear</button>
                                <input type="color" id="color-picker" value="#000000">
                                <input type="range" id="brush-size" min="1" max="10" value="3">
                            </div>
                            
                            <!-- Canvas -->
                            <canvas id="whiteboard-canvas" width="800" height="400" style="border: 1px solid #ccc; background: white; display: block; margin: 10px 0;"></canvas>
                        </div>

                        <script>
                        (function() {
                            const canvas = document.getElementById('whiteboard-canvas');
                            const ctx = canvas.getContext('2d');
                            const canDraw = <%= current_user == lobby.owner || lobby.lobby_members.find_by(user: current_user)&.can_draw || false %>;
                            
                            let currentTool = 'pen';
                            let isDrawing = false;
                            let currentColor = '#000000';
                            let currentSize = 3;
                            
                            // Add grid
                            function drawGrid() {
                                ctx.strokeStyle = '#f0f0f0';
                                ctx.lineWidth = 1;
                                for (let x = 0; x <= 800; x += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(x, 0);
                                    ctx.lineTo(x, 400);
                                    ctx.stroke();
                                }
                                for (let y = 0; y <= 400; y += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(0, y);
                                    ctx.lineTo(800, y);
                                    ctx.stroke();
                                }
                            }
                            
                            // Tool selection
                            document.getElementById('pen-tool').onclick = () => selectTool('pen');
                            document.getElementById('text-tool').onclick = () => selectTool('text');
                            document.getElementById('rect-tool').onclick = () => selectTool('rect');
                            document.getElementById('circle-tool').onclick = () => selectTool('circle');
                            document.getElementById('sticky-tool').onclick = () => selectTool('sticky');
                            document.getElementById('clear-btn').onclick = clearCanvas;
                            
                            document.getElementById('color-picker').onchange = (e) => currentColor = e.target.value;
                            document.getElementById('brush-size').oninput = (e) => currentSize = e.target.value;
                            
                            function selectTool(tool) {
                                currentTool = tool;
                                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                                document.getElementById(tool + '-tool').classList.add('active');
                            }
                            
                            function clearCanvas() {
                                if (confirm('Clear whiteboard?')) {
                                    ctx.clearRect(0, 0, 800, 400);
                                    drawGrid();
                                }
                            }
                            
                            // Drawing
                            let drawing = false;
                            let currentPath = [];
                            
                            canvas.onmousedown = (e) => {
                                if (!canDraw) return;
                                const rect = canvas.getBoundingClientRect();
                                const x = e.clientX - rect.left;
                                const y = e.clientY - rect.top;
                                
                                if (currentTool === 'pen') {
                                    drawing = true;
                                    currentPath = [{x, y}];
                                } else if (currentTool === 'text') {
                                    const text = prompt('Enter text:');
                                    if (text) {
                                        ctx.fillStyle = currentColor;
                                        ctx.font = (currentSize * 4) + 'px Arial';
                                        ctx.fillText(text, x, y);
                                    }
                                } else if (currentTool === 'rect') {
                                    ctx.strokeStyle = currentColor;
                                    ctx.lineWidth = 2;
                                    ctx.strokeRect(x, y, 100, 60);
                                } else if (currentTool === 'circle') {
                                    ctx.strokeStyle = currentColor;
                                    ctx.lineWidth = 2;
                                    ctx.beginPath();
                                    ctx.arc(x, y, 30, 0, 2 * Math.PI);
                                    ctx.stroke();
                                } else if (currentTool === 'sticky') {
                                    const text = prompt('Sticky note text:') || 'Note';
                                    ctx.fillStyle = '#fff59d';
                                    ctx.fillRect(x, y, 120, 80);
                                    ctx.strokeStyle = '#f57f17';
                                    ctx.lineWidth = 2;
                                    ctx.strokeRect(x, y, 120, 80);
                                    ctx.fillStyle = '#333';
                                    ctx.font = '14px Arial';
                                    ctx.fillText(text, x + 5, y + 20);
                                }
                            };
                            
                            canvas.onmousemove = (e) => {
                                if (!drawing || currentTool !== 'pen') return;
                                const rect = canvas.getBoundingClientRect();
                                const x = e.clientX - rect.left;
                                const y = e.clientY - rect.top;
                                currentPath.push({x, y});
                                
                                // Draw current stroke
                                ctx.strokeStyle = currentColor;
                                ctx.lineWidth = currentSize;
                                ctx.lineCap = 'round';
                                ctx.beginPath();
                                ctx.moveTo(currentPath[currentPath.length-2].x, currentPath[currentPath.length-2].y);
                                ctx.lineTo(x, y);
                                ctx.stroke();
                            };
                            
                            canvas.onmouseup = () => {
                                drawing = false;
                                currentPath = [];
                            };
                            
                            // Initialize
                            drawGrid();
                        })();
                        </script>

                        <style>
                        .whiteboard-container {
                            background: #f9f9f9;
                            padding: 10px;
                            border-radius: 8px;
                            margin: 10px 0;
                        }
                        .whiteboard-toolbar {
                            display: flex;
                            gap: 10px;
                            margin-bottom: 10px;
                            align-items: center;
                            flex-wrap: wrap;
                        }
                        .tool-btn {
                            padding: 8px 12px;
                            border: 1px solid #ccc;
                            background: white;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                        }
                        .tool-btn:hover { background: #f0f0f0; }
                        .tool-btn.active { background: #007bff; color: white; }
                        .tool-btn.danger { background: #dc3545; color: white; }
                        #color-picker { width: 40px; height: 35px; border: 1px solid #ccc; }
                        #brush-size { width: 100px; }
                        </style>
                    </div>
                        
                        <!-- Legacy Stimulus Whiteboard Container (Hidden by default) -->
                        </style>
                    </div>

                    <!-- Right Column: Participants -->                            <!-- Enhanced Controls (Hidden by default, shown when JS loads and user can draw) -->
                            <div class="whiteboard-advanced-controls" data-whiteboard-target="advancedControls" style="display: none;">
                                <div class="toolbar-enhanced">
                                    <div class="tool-group">
                                        <button class="tool-btn" data-tool="select" data-action="click->whiteboard#selectTool" title="Select (V)">
                                            üëÜ Select
                                        </button>
                                        <button class="tool-btn" data-tool="pen" data-action="click->whiteboard#selectTool" title="Freehand (P)">
                                            ‚úèÔ∏è Draw
                                        </button>
                                        <button class="tool-btn" data-tool="text" data-action="click->whiteboard#selectTool">
                                            üìù Text
                                        </button>
                                        <button class="tool-btn" data-tool="rectangle" data-action="click->whiteboard#selectTool">
                                            ‚¨ú Rectangle
                                        </button>
                                        <button class="tool-btn" data-tool="circle" data-action="click->whiteboard#selectTool">
                                            ‚≠ï Circle
                                        </button>
                                        <button class="tool-btn" data-tool="sticky" data-action="click->whiteboard#selectTool" title="Sticky Note (N)">
                                            üìå Sticky
                                        </button>
                                        <button class="tool-btn" data-action="click->whiteboard#undo" title="Undo (Ctrl+Z)">‚Ü∂ Undo</button>
                                        <button class="tool-btn" data-action="click->whiteboard#redo" title="Redo (Ctrl+Y)">‚Ü∑ Redo</button>
                                        <button class="tool-btn" data-tool="pan" data-action="click->whiteboard#selectTool" title="Pan (Space drag)">üñêÔ∏è Pan</button>
                                        <button class="tool-btn" data-action="click->whiteboard#zoomIn" title="Zoom In (+)">‚ûï</button>
                                        <button class="tool-btn" data-action="click->whiteboard#zoomOut" title="Zoom Out (-)">‚ûñ</button>
                                        <button class="tool-btn danger" data-action="click->whiteboard#clearCanvas">
                                            üóëÔ∏è Clear
                                        </button>
                                        <label class="inline-label">Color: <input type="color" value="#000000" data-whiteboard-target="color" data-action="input->whiteboard#changeColor change->whiteboard#changeColor"></label>
                                        <label class="inline-label">Brush Size: <input type="range" min="1" max="20" value="3" data-whiteboard-target="brushSize" data-action="input->whiteboard#changeBrushSize change->whiteboard#changeBrushSize"></label>
                                        <span class="status" data-whiteboard-target="status"></span>
                                    </div>
                                    <div class="whiteboard-help">
                                        <small>üí° Click anywhere to add shapes/text, or use draw tool to sketch freely</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Basic Controls (Always available, hidden when JS enhances) -->
                            <% if current_user == lobby.owner || lobby.lobby_members.find_by(user: current_user)&.can_draw %>
                                <div class="whiteboard-basic-controls" data-whiteboard-target="basicControls">
                                    <details class="basic-controls-toggle">
                                        <summary>üìù Add Content (Works without JavaScript)</summary>
                                        <div class="basic-controls-content">
                                            <!-- Custom Text Tool -->
                                            <div class="tool-group">
                                                <label class="tool-label">Add Custom Text:</label>
                                                <div class="custom-text-form">
                                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "text-form" do |f| %>
                                                        <%= f.hidden_field :tool, value: "text" %>
                                                        <div class="form-row">
                                                            <%= f.text_field :text, placeholder: "Enter your text...", class: "text-input", required: true %>
                                                        </div>
                                                        <div class="form-row coordinates">
                                                            <%= f.number_field :x, placeholder: "X (0-800)", class: "coord-input", min: 0, max: 800, value: 400 %>
                                                            <%= f.number_field :y, placeholder: "Y (0-300)", class: "coord-input", min: 0, max: 300, value: 150 %>
                                                        </div>
                                                        <div class="form-row">
                                                            <%= f.color_field :color, value: "#000000", class: "color-input" %>
                                                            <%= f.submit "Add Text", class: "tool-btn primary" %>
                                                        </div>
                                                    <% end %>
                                                </div>
                                            </div>
                                            
                                            <!-- Quick Shapes / Line -->
                                            <div class="tool-group">
                                                <label class="tool-label">Quick Shapes:</label>
                                                <div class="tool-buttons">
                                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                                        <%= f.hidden_field :tool, value: "rectangle" %>
                                                        <%= f.hidden_field :x, value: rand(50..400) %>
                                                        <%= f.hidden_field :y, value: rand(40..180) %>
                                                        <%= f.hidden_field :width, value: 80 %>
                                                        <%= f.hidden_field :height, value: 50 %>
                                                        <%= f.hidden_field :color, value: "#000000" %>
                                                        <%= f.submit "‚¨ú Rectangle", class: "tool-btn primary" %>
                                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                                        <%= f.hidden_field :tool, value: "line" %>
                                                        <%= f.hidden_field :x1, value: rand(0..300) %>
                                                        <%= f.hidden_field :y1, value: rand(0..150) %>
                                                        <%= f.hidden_field :x2, value: rand(300..800) %>
                                                        <%= f.hidden_field :y2, value: rand(150..300) %>
                                                        <%= f.hidden_field :color, value: "#000000" %>
                                                        <%= f.hidden_field :width, value: 2 %>
                                                        <%= f.submit "Line", class: "tool-btn primary" %>
                                                    <% end %>
                                                    <% end %>
                                                    
                                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                                        <%= f.hidden_field :tool, value: "circle" %>
                                                        <%= f.hidden_field :x, value: rand(80..500) %>
                                                        <%= f.hidden_field :y, value: rand(60..200) %>
                                                        <%= f.hidden_field :radius, value: 35 %>
                                                        <%= f.hidden_field :color, value: "#000000" %>
                                                        <%= f.submit "‚≠ï Circle", class: "tool-btn primary" %>
                                                    <% end %>
                                                    
                                                    <%= form_with url: clear_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                                        <%= f.submit "üóëÔ∏è Clear", class: "tool-btn danger", 
                                                            data: { confirm: "Clear the whiteboard?" } %>
                                                    <% end %>
                                                </div>
                                            </div>
                                        </div>
                                    </details>
                                </div>
                            <% else %>
                                <div class="whiteboard-readonly-notice">
                                    <small>üëÄ You can view the whiteboard but don't have permission to edit it.</small>
                                </div>
                            <% end %>

                            <!-- No JavaScript Fallback -->
                            <noscript>
                                <div class="no-js-notice">
                                    <p><strong>JavaScript is disabled.</strong> You can still view and use the whiteboard with basic controls above.</p>
                                </div>
                            </noscript>
                        </div>
                    </div>

                    <!-- Right Column: Participants -->
                    <div class="lobby-section">
                        <h3 class="section-title">Participants (<%= lobby.lobby_members.length %>)</h3>
                        <div class="participants-list">
                            <% if lobby.lobby_members.any? %>
                                <ul class="lobby-members">
                                    <% lobby.lobby_members.each do |member| %>
                                        <li class="participant-item">
                                            <div class="participant-avatar">
                                                <%= member.user.first_name.first.upcase %>
                                            </div>
                                            <span class="participant-name"><%= member.user.full_name %></span>
                                            <div class="participant-status">
                                                <span class="status-dot online" title="Online"></span>
                                            </div>
                                        </li>
                                    <% end %>
                                </ul>
                            <% end %>
                        </div>

                        <!-- Voice Chat Section -->
                        <div class="voice-chat-section">
                            <h4 class="section-title">Voice Chat</h4>
                            <div class="voice-controls">
                                <button class="voice-btn" id="mute-btn">üé§ Mute</button>
                                <button class="voice-btn" id="leave-btn">üìû Leave</button>
                            </div>
                        </div>

                        <!-- Lobby Analytics -->
                        <div class="lobby-analytics">
                            <h4 class="section-title">Lobby Analytics</h4>
                            <div class="analytics-item">
                                <span>Session Duration:</span>
                                <span class="analytics-value">1h 30m</span>
                            </div>
                            <div class="analytics-item">
                                <span>Active Users:</span>
                                <span class="analytics-value"><%= lobby.lobby_members.length %>/5</span>
                            </div>
                            <div class="analytics-item">
                                <span>Problems Solved:</span>
                                <span class="analytics-value">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description and Permissions Section -->
                <div class="lobby-details">
                    <h3 class="section-title">Description</h3>
                    <div class="lobby-description"><%= lobby.description %></div>
                    
                    <% if current_user == lobby.owner %>
                        <div class="lobby-code-display">
                            <strong>Lobby Code:</strong> <span><%= lobby.lobby_code %></span>
                        </div>
                    <% end %>

                    <% if current_user == lobby.owner && lobby.lobby_members.length > 1 %>
                        <hr>
                        <h3 class="page-title">Manage Permissions</h3>

                        <%= form_with(model: lobby, url: update_all_lobby_permissions_path(lobby), method: :patch) do |form| %>
                            <table class="permissions-table">
                            <thead>
                                <tr>
                                <th>Participant</th>
                                <th>Can Draw</th>
                                <th>Can Edit Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% form.fields_for :lobby_members do |member_form| %>
                                <% next if member_form.object.user == lobby.owner %>
                                <tr>
                                    <td>
                                    <%= member_form.object.user.full_name %>
                                    <%= member_form.hidden_field :id %>
                                    </td>
                                    <td>
                                    <%= member_form.label :can_draw, "Can Draw", class: "visually-hidden" %>
                                    <%= member_form.check_box :can_draw %>
                                    </td>
                                    <td>
                                    <%= member_form.label :can_edit_notes, "Can Edit Notes", class: "visually-hidden" %>
                                    <%= member_form.check_box :can_edit_notes %>
                                    </td>
                                </tr>
                                <% end %>
                            </tbody>
                            </table>
                            <div class="lobby-actions">
                                <%= form.submit "Update All Permissions", class: "btn btn-primary" %>
                            </div>
                        <% end %>
                    <% end %>

                    <div class="lobby-actions">
                        <% if current_user == lobby.owner %>
                            <%= link_to "Destroy Lobby", lobby, 
                                        data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, 
                                        class: "btn btn-danger" %>
                        <% else %>
                            <%= button_to "Leave Lobby", leave_lobby_path(lobby), 
                                        method: :delete, 
                                        class: "btn btn-warning" %>
                        <% end %>
                        
                        <%= link_to "Back to Lobbies", lobbies_path, class: "btn btn-secondary" %>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>