<div class="app-container"><div class="app-container">

    <%= render 'shared/navbar' %>    <%= render 'shared/navbar' %>



    <main class="main-content">    <main class="main-content">

        <div id="lobbiesPage" class="page">        <div id="lobbiesPage" class="page">

            <div class="page-header align">            <div class="page-header align">

                <div>                <div>

                    <h1 class="page-title"><%= lobby.name.presence || 'UNNAMED LOBBY' %></h1>                    <h1 class="page-title"><%= lobby.name.presence || 'UNNAMED LOBBY' %></h1>

                    <p class="page-subtitle">                    <p class="page-subtitle">

                        Host: <%= lobby.owner.full_name %> | Visibility: <%= lobby.private? ? 'Private' : 'Public' %>                        Host: <%= lobby.owner.full_name %> | Visibility: <%= lobby.private? ? 'Private' : 'Public' %>

                    </p>                    </p>

                </div>                </div>

            </div>            </div>



            <div class="content-area">            <div class="content-area">

                <!-- Three Column Layout -->                <h3 class="page-title">Description</h3>

                <div class="lobby-layout">                <div class="lobby-description"><%= lobby.description %></div>

                    <!-- Left Column: Shared Notes -->                <br/>

                    <div class="lobby-section">

                        <h3 class="section-title">Shared Notes</h3>                <%# Shows the lobby code to the owner for sharing %>

                        <div class="notes-area">                <% if current_user == lobby.owner %>

                            <textarea placeholder="Take shared notes here..." rows="10"></textarea>                    <div class="lobby-code-display">

                        </div>                        <strong>Lobby Code:</strong> <span><%= lobby.lobby_code %></span>

                    </div>                    </div>

                    <br/>

                    <!-- Center Column: Shared Whiteboard -->                <% end %>

                    <div class="lobby-section whiteboard-section">

                        <h3 class="section-title">ðŸŽ¨ Shared Whiteboard</h3>                <h3 class="page-title">Participants (<%= lobby.lobby_members.length %>)</h3>

                                        <% if lobby.lobby_members.any? %>

                        <!-- SVG Canvas -->                    <ul class="lobby-members">

                        <div class="whiteboard-canvas">                        <% lobby.lobby_members.each do |member| %>

                            <% if lobby.whiteboard&.svg_data.present? %>                            <li><%= member.user.full_name %></li>

                                <%= lobby.whiteboard.svg_data.html_safe %>                        <% end %>

                            <% else %>                    </ul>

                                <svg width="100%" height="300" viewBox="0 0 800 300" xmlns="http://www.w3.org/2000/svg" class="whiteboard-svg">                <% end %>

                                    <defs>

                                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">                <%# --- Permissions Management Form (Owner Only & More Than 1 Member) --- %>

                                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#444" stroke-width="0.5" opacity="0.5"/>                <% if current_user == lobby.owner && lobby.lobby_members.length > 1 %>

                                        </pattern>                    <hr>

                                    </defs>                    <h3 class="page-title">Manage Permissions</h3>

                                    <rect width="100%" height="100%" fill="url(#grid)"/>

                                    <text x="400" y="150" text-anchor="middle" fill="#888" font-family="Arial" font-size="16" opacity="0.8">                    <%= form_with(model: lobby, url: update_all_lobby_permissions_path(lobby), method: :patch) do |form| %>

                                        ðŸš€ Collaborative Whiteboard - Click tools below to add shapes                        <table class="permissions-table">

                                    </text>                        <thead>

                                </svg>                            <tr>

                            <% end %>                            <th>Participant</th>

                        </div>                            <th>Can Draw</th>

                                                    <th>Can Edit Notes</th>

                        <!-- Compact Tool Bar -->                            </tr>

                        <div class="whiteboard-toolbar">                        </thead>

                            <!-- Basic Shapes -->                        <tbody>

                            <div class="tool-group">                            <%= form.fields_for :lobby_members do |member_form| %>

                                <label class="tool-label">Basic Shapes:</label>                            <% next if member_form.object.user == lobby.owner %>

                                <div class="tool-buttons">                            <tr>

                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>                                <td>

                                        <%= f.hidden_field :tool, value: "rectangle" %>                                <%= member_form.object.user.full_name %>

                                        <%= f.hidden_field :x, value: rand(50..400) %>                                <%= member_form.hidden_field :id %>

                                        <%= f.hidden_field :y, value: rand(40..180) %>                                </td>

                                        <%= f.hidden_field :width, value: 80 %>                                <td>

                                        <%= f.hidden_field :height, value: 50 %>                                <%# Add a hidden label that Capybara can find %>

                                        <%= f.hidden_field :color, value: "#ffffff" %>                                <%= member_form.label :can_draw, "Can Draw", class: "visually-hidden" %>

                                        <%= f.submit "â¬œ Rectangle", class: "tool-btn primary" %>                                <%= member_form.check_box :can_draw %>

                                    <% end %>                                </td>

                                                                    <td>

                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>                                <%# Add a hidden label for the other checkbox as well %>

                                        <%= f.hidden_field :tool, value: "circle" %>                                <%= member_form.label :can_edit_notes, "Can Edit Notes", class: "visually-hidden" %>

                                        <%= f.hidden_field :x, value: rand(80..500) %>                                <%= member_form.check_box :can_edit_notes %>

                                        <%= f.hidden_field :y, value: rand(60..200) %>                                </td>

                                        <%= f.hidden_field :radius, value: 35 %>                            </tr>

                                        <%= f.hidden_field :color, value: "#44ff44" %>                            <% end %>

                                        <%= f.submit "â­• Circle", class: "tool-btn primary" %>                        </tbody>

                                    <% end %>                        </table>

                                                            <div class="lobby-actions">

                                    <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>                            <%= form.submit "Update All Permissions", class: "btn btn-primary" %>

                                        <%= f.hidden_field :tool, value: "text" %>                        </div>

                                        <%= f.hidden_field :x, value: rand(80..500) %>                    <% end %>

                                        <%= f.hidden_field :y, value: rand(80..220) %>                <% end %>

                                        <%= f.hidden_field :text, value: "ðŸ’¡ Idea" %>

                                        <%= f.hidden_field :color, value: "#ffff44" %>                <hr>

                                        <%= f.submit "ðŸ’¡ Text", class: "tool-btn primary" %>

                                    <% end %>                <%# --- Main Action Buttons (Separated Logic for All Users) --- %>

                                </div>                <div class="lobby-actions">

                            </div>                    <% if current_user == lobby.owner %>

                                                    <%# Owner sees the Destroy button %>

                            <!-- Quick Colors -->                        <%= link_to "Destroy Lobby", lobby, 

                            <div class="tool-group">                                    data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, 

                                <label class="tool-label">Quick Colors:</label>                                    class: "btn btn-danger" %>

                                <div class="tool-buttons">                    <% else %>

                                    <% [                        <%# Participants see the Leave button %>

                                        { name: "Red", value: "#ff4444", emoji: "ðŸ”´" },                        <%= button_to "Leave Lobby", leave_lobby_path(lobby), 

                                        { name: "Blue", value: "#4444ff", emoji: "ðŸ”µ" },                                    method: :delete, 

                                        { name: "Green", value: "#44ff44", emoji: "ðŸŸ¢" },                                    class: "btn btn-warning" %>

                                        { name: "Yellow", value: "#ffff44", emoji: "ðŸŸ¡" }                    <% end %>

                                    ].each do |color| %>                    

                                        <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>                    <%# Everyone sees the "Back to Lobbies" button %>

                                            <%= f.hidden_field :tool, value: "circle" %>                    <%= link_to "Back to Lobbies", lobbies_path, class: "btn btn-secondary" %>

                                            <%= f.hidden_field :x, value: rand(80..500) %>                </div>

                                            <%= f.hidden_field :y, value: rand(60..200) %>            </div>

                                            <%= f.hidden_field :radius, value: 30 %>        </main>

                                            <%= f.hidden_field :color, value: color[:value] %></div>
                                            <%= f.submit color[:emoji], class: "tool-btn color", title: color[:name] %>
                                        <% end %>
                                    <% end %>
                                </div>
                            </div>
                            
                            <!-- Quick Text -->
                            <div class="tool-group">
                                <label class="tool-label">Quick Text:</label>
                                <div class="tool-buttons">
                                    <% ["Algorithm", "Big O", "Solution"].each do |text| %>
                                        <%= form_with url: add_drawing_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                            <%= f.hidden_field :tool, value: "text" %>
                                            <%= f.hidden_field :x, value: rand(50..500) %>
                                            <%= f.hidden_field :y, value: rand(80..220) %>
                                            <%= f.hidden_field :text, value: text %>
                                            <%= f.hidden_field :color, value: "#ffffff" %>
                                            <%= f.submit text, class: "tool-btn text" %>
                                        <% end %>
                                    <% end %>
                                </div>
                            </div>
                            
                            <!-- Controls -->
                            <div class="tool-group">
                                <div class="tool-buttons">
                                    <%= form_with url: clear_lobby_whiteboards_path(lobby), method: :post, local: true, class: "inline-form" do |f| %>
                                        <%= f.submit "ðŸ—‘ï¸ Clear", class: "tool-btn danger", 
                                            data: { confirm: "Clear the whiteboard?" } %>
                                    <% end %>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Participants, Voice Chat, Analytics -->
                    <div class="lobby-section">
                        <h3 class="section-title">Participants (<%= lobby.lobby_members.length %>)</h3>
                        <div class="participants-list">
                            <% if lobby.lobby_members.any? %>
                                <ul class="lobby-members">
                                    <% lobby.lobby_members.each do |member| %>
                                        <li class="participant-item">
                                            <div class="participant-avatar">
                                                <%= member.user.first_name.first.upcase %>
                                            </div>
                                            <span class="participant-name"><%= member.user.full_name %></span>
                                            <div class="participant-status">
                                                <span class="status-dot online" title="Online"></span>
                                            </div>
                                        </li>
                                    <% end %>
                                </ul>
                            <% end %>
                        </div>

                        <!-- Voice Chat Section -->
                        <div class="voice-chat-section">
                            <h4 class="section-title">Voice Chat</h4>
                            <div class="voice-controls">
                                <button class="voice-btn" id="mute-btn">ðŸŽ¤ Mute</button>
                                <button class="voice-btn" id="leave-btn">ðŸ“ž Leave</button>
                            </div>
                        </div>

                        <!-- Lobby Analytics -->
                        <div class="lobby-analytics">
                            <h4 class="section-title">Lobby Analytics</h4>
                            <div class="analytics-item">
                                <span>Session Duration:</span>
                                <span class="analytics-value">1h 30m</span>
                            </div>
                            <div class="analytics-item">
                                <span>Active Users:</span>
                                <span class="analytics-value"><%= lobby.lobby_members.length %>/5</span>
                            </div>
                            <div class="analytics-item">
                                <span>Problems Solved:</span>
                                <span class="analytics-value">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description and Permissions Section -->
                <div class="lobby-details">
                    <h3 class="section-title">Description</h3>
                    <div class="lobby-description"><%= lobby.description %></div>
                    
                    <%# Shows the lobby code to the owner for sharing %>
                    <% if current_user == lobby.owner %>
                        <div class="lobby-code-display">
                            <strong>Lobby Code:</strong> <span><%= lobby.lobby_code %></span>
                        </div>
                    <% end %>

                    <%# --- Permissions Management Form (Owner Only & More Than 1 Member) --- %>
                    <% if current_user == lobby.owner && lobby.lobby_members.length > 1 %>
                        <hr>
                        <h3 class="page-title">Manage Permissions</h3>

                        <%= form_with(model: lobby, url: update_all_lobby_permissions_path(lobby), method: :patch) do |form| %>
                            <table class="permissions-table">
                            <thead>
                                <tr>
                                <th>Participant</th>
                                <th>Can Draw</th>
                                <th>Can Edit Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <%= form.fields_for :lobby_members do |member_form| %>
                                <% next if member_form.object.user == lobby.owner %>
                                <tr>
                                    <td>
                                    <%= member_form.object.user.full_name %>
                                    <%= member_form.hidden_field :id %>
                                    </td>
                                    <td>
                                    <%# Add a hidden label that Capybara can find %>
                                    <%= member_form.label :can_draw, "Can Draw", class: "visually-hidden" %>
                                    <%= member_form.check_box :can_draw %>
                                    </td>
                                    <td>
                                    <%# Add a hidden label for the other checkbox as well %>
                                    <%= member_form.label :can_edit_notes, "Can Edit Notes", class: "visually-hidden" %>
                                    <%= member_form.check_box :can_edit_notes %>
                                    </td>
                                </tr>
                                <% end %>
                            </tbody>
                            </table>
                            <div class="lobby-actions">
                                <%= form.submit "Update All Permissions", class: "btn btn-primary" %>
                            </div>
                        <% end %>
                    <% end %>

                    <%# --- Main Action Buttons (Separated Logic for All Users) --- %>
                    <div class="lobby-actions">
                        <% if current_user == lobby.owner %>
                            <%# Owner sees the Destroy button %>
                            <%= link_to "Destroy Lobby", lobby, 
                                        data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, 
                                        class: "btn btn-danger" %>
                        <% else %>
                            <%# Participants see the Leave button %>
                            <%= button_to "Leave Lobby", leave_lobby_path(lobby), 
                                        method: :delete, 
                                        class: "btn btn-warning" %>
                        <% end %>
                        
                        <%# Everyone sees the "Back to Lobbies" button %>
                        <%= link_to "Back to Lobbies", lobbies_path, class: "btn btn-secondary" %>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>