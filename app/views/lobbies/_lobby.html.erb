<div class="app-container">
    <%= render 'shared/navbar' %>

    <main class="main-content">
        <div id="lobbiesPage" class="page">
            <div class="page-header align">
                <div>
                    <h1 class="page-title"><%= lobby.name.presence || 'UNNAMED LOBBY' %></h1>
                    <p class="page-subtitle">
                        Host: <%= lobby.owner.full_name %> | Visibility: <%= lobby.private? ? 'Private' : 'Public' %>
                    </p>
                </div>
            </div>

            <div class="content-area">
                <!-- Three Column Layout -->
                <div class="lobby-layout">
                    <!-- Left Column: Shared Notes -->
                    <div class="lobby-section">
                        <h3 class="section-title">Shared Notes</h3>
                                                <div class="notes-area">
                                                        <% if lobby.whiteboard %>
                                                            <% editable_notes = (current_user == lobby.owner) || lobby.lobby_members.find_by(user: current_user)&.can_edit_notes %>
                                                            <% if editable_notes %>
                                                                <%= form_with model: lobby.whiteboard, url: update_notes_lobby_whiteboards_path(lobby), method: :patch, local: true do |f| %>
                                                                    <%= f.text_area :notes, rows: 10, placeholder: "Take shared notes here...", value: lobby.whiteboard.notes, class: "shared-notes" %>
                                                                    <div class="form-row">
                                                                        <%= f.submit "Save Notes", class: "btn btn-primary" %>
                                                                    </div>
                                                                <% end %>
                                                            <% else %>
                                                                <textarea rows="10" readonly placeholder="No notes yet"> <%= lobby.whiteboard.notes %></textarea>
                                                                <small>You don't have permission to edit notes.</small>
                                                            <% end %>
                                                        <% else %>
                                                            <em>Whiteboard not initialized.</em>
                                                        <% end %>
                                                </div>
                    </div>

                    <!-- Center Column: Shared Whiteboard -->
                    <div class="lobby-section whiteboard-section">
                        <h3 class="section-title">Shared Whiteboard</h3>
                        
                        <!-- Simple Whiteboard -->
                        <div class="whiteboard-container">
                            <!-- Toolbar -->
                            <div class="whiteboard-toolbar">
                                <button id="pen-tool" class="tool-btn active">‚úèÔ∏è Draw</button>
                                <button id="text-tool" class="tool-btn">üìù Text</button>
                                <button id="rect-tool" class="tool-btn">‚¨ú Rectangle</button>
                                <button id="circle-tool" class="tool-btn">‚≠ï Circle</button>
                                <button id="clear-btn" class="tool-btn danger">üóëÔ∏è Clear</button>
                                <input type="color" id="color-picker" value="#000000">
                                <input type="range" id="brush-size" min="1" max="10" value="3">
                            </div>
                            
                            <!-- Canvas -->
                            <canvas id="whiteboard-canvas" width="800" height="400" style="border: 1px solid #ccc; background: white; display: block; margin: 10px 0; max-width: 100%; height: auto;"></canvas>
                        </div>

                        <script>
                        (function() {
                            const canvas = document.getElementById('whiteboard-canvas');
                            const ctx = canvas.getContext('2d');
                            const canDraw = <%= current_user == lobby.owner || lobby.lobby_members.find_by(user: current_user)&.can_draw || false %>;
                            
                            let currentTool = 'pen';
                            let isDrawing = false;
                            let currentColor = '#000000';
                            let currentSize = 3;
                            
                            // Add grid
                            function drawGrid() {
                                ctx.strokeStyle = '#f0f0f0';
                                ctx.lineWidth = 1;
                                for (let x = 0; x <= 800; x += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(x, 0);
                                    ctx.lineTo(x, 400);
                                    ctx.stroke();
                                }
                                for (let y = 0; y <= 400; y += 20) {
                                    ctx.beginPath();
                                    ctx.moveTo(0, y);
                                    ctx.lineTo(800, y);
                                    ctx.stroke();
                                }
                            }
                            
                            // Tool selection
                            document.getElementById('pen-tool').onclick = () => selectTool('pen');
                            document.getElementById('text-tool').onclick = () => selectTool('text');
                            document.getElementById('rect-tool').onclick = () => selectTool('rect');
                            document.getElementById('circle-tool').onclick = () => selectTool('circle');
                            document.getElementById('clear-btn').onclick = clearCanvas;
                            
                            document.getElementById('color-picker').onchange = (e) => currentColor = e.target.value;
                            document.getElementById('brush-size').oninput = (e) => currentSize = e.target.value;
                            
                            function selectTool(tool) {
                                currentTool = tool;
                                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                                document.getElementById(tool + '-tool').classList.add('active');
                            }
                            
                            function clearCanvas() {
                                if (confirm('Clear whiteboard?')) {
                                    ctx.clearRect(0, 0, 800, 400);
                                    drawGrid();
                                }
                            }
                            
                            // Drawing
                            let drawing = false;
                            let currentPath = [];
                            
                            canvas.onmousedown = (e) => {
                                if (!canDraw) return;
                                const rect = canvas.getBoundingClientRect();
                                const x = e.clientX - rect.left;
                                const y = e.clientY - rect.top;
                                
                                if (currentTool === 'pen') {
                                    drawing = true;
                                    currentPath = [{x, y}];
                                } else if (currentTool === 'text') {
                                    const text = prompt('Enter text:');
                                    if (text) {
                                        ctx.fillStyle = currentColor;
                                        ctx.font = (currentSize * 4) + 'px Arial';
                                        ctx.fillText(text, x, y);
                                    }
                                } else if (currentTool === 'rect') {
                                    ctx.strokeStyle = currentColor;
                                    ctx.lineWidth = 2;
                                    ctx.strokeRect(x, y, 100, 60);
                                } else if (currentTool === 'circle') {
                                    ctx.strokeStyle = currentColor;
                                    ctx.lineWidth = 2;
                                    ctx.beginPath();
                                    ctx.arc(x, y, 30, 0, 2 * Math.PI);
                                    ctx.stroke();
                                }
                            };
                            
                            canvas.onmousemove = (e) => {
                                if (!drawing || currentTool !== 'pen') return;
                                const rect = canvas.getBoundingClientRect();
                                const x = e.clientX - rect.left;
                                const y = e.clientY - rect.top;
                                currentPath.push({x, y});
                                
                                // Draw current stroke
                                ctx.strokeStyle = currentColor;
                                ctx.lineWidth = currentSize;
                                ctx.lineCap = 'round';
                                ctx.beginPath();
                                ctx.moveTo(currentPath[currentPath.length-2].x, currentPath[currentPath.length-2].y);
                                ctx.lineTo(x, y);
                                ctx.stroke();
                            };
                            
                            canvas.onmouseup = () => {
                                drawing = false;
                                currentPath = [];
                            };
                            
                            // Initialize
                            drawGrid();
                            
                            // Responsive canvas handling
                            function resizeCanvas() {
                                const container = canvas.parentElement;
                                const containerWidth = container.clientWidth - 20; // Account for padding
                                const maxWidth = 800;
                                const aspectRatio = 400 / 800;
                                
                                if (containerWidth < maxWidth) {
                                    canvas.style.width = containerWidth + 'px';
                                    canvas.style.height = (containerWidth * aspectRatio) + 'px';
                                } else {
                                    canvas.style.width = maxWidth + 'px';
                                    canvas.style.height = '400px';
                                }
                            }
                            
                            // Initial resize
                            resizeCanvas();
                            
                            // Resize on window resize
                            window.addEventListener('resize', resizeCanvas);
                        })();
                        </script>

                        <style>
                        /* Override any conflicting whiteboard styles */
                        .whiteboard-container {
                            background: #f8f9fa !important;
                            padding: 10px !important;
                            border-radius: 6px !important;
                            margin: 0 !important;
                            height: calc(100% - 40px) !important;
                            display: flex !important;
                            flex-direction: column !important;
                        }
                        .whiteboard-toolbar {
                            display: flex !important;
                            gap: 8px !important;
                            margin-bottom: 10px !important;
                            padding: 8px !important;
                            background: white !important;
                            border-radius: 4px !important;
                            border: 1px solid #ddd !important;
                            flex-wrap: wrap !important;
                            align-items: center !important;
                        }
                        .tool-btn {
                            padding: 6px 12px !important;
                            border: 1px solid #ccc !important;
                            background: white !important;
                            border-radius: 3px !important;
                            cursor: pointer !important;
                            font-size: 12px !important;
                            white-space: nowrap !important;
                        }
                        .tool-btn:hover { 
                            background: #f0f0f0 !important; 
                        }
                        .tool-btn.active { 
                            background: #007bff !important; 
                            color: white !important; 
                            border-color: #007bff !important;
                        }
                        .tool-btn.danger { 
                            background: #dc3545 !important; 
                            color: white !important; 
                            border-color: #dc3545 !important;
                        }
                        #color-picker { 
                            width: 30px !important; 
                            height: 30px !important; 
                            border: 1px solid #ccc !important; 
                            border-radius: 3px !important;
                            cursor: pointer !important;
                        }
                        #brush-size { 
                            width: 80px !important;
                        }
                        #whiteboard-canvas {
                            flex: 1 !important;
                            background: white !important;
                            border: 1px solid #ddd !important;
                            border-radius: 4px !important;
                            display: block !important;
                            width: 100% !important;
                            max-width: 100% !important;
                        }
                        </style>
                    </div>
                        
                    <!-- Right Column: Participants -->
                    <div class="lobby-section">
                        <h3 class="section-title">Participants (<%= lobby.lobby_members.length %>)</h3>
                        <div class="participants-list">
                            <% if lobby.lobby_members.any? %>
                                <ul class="lobby-members">
                                    <% lobby.lobby_members.each do |member| %>
                                        <li class="participant-item">
                                            <div class="participant-avatar">
                                                <%= member.user.first_name.first.upcase %>
                                            </div>
                                            <span class="participant-name"><%= member.user.full_name %></span>
                                            <div class="participant-status">
                                                <span class="status-dot online" title="Online"></span>
                                            </div>
                                        </li>
                                    <% end %>
                                </ul>
                            <% end %>
                        </div>

                        <!-- Voice Chat Section -->
                        <div class="voice-chat-section">
                            <h4 class="section-title">Voice Chat</h4>
                            <div class="voice-controls">
                                <button class="voice-btn" id="mute-btn">üé§ Mute</button>
                                <button class="voice-btn" id="leave-btn">üìû Leave</button>
                            </div>
                        </div>

                        <!-- Lobby Analytics -->
                        <div class="lobby-analytics">
                            <h4 class="section-title">Lobby Analytics</h4>
                            <div class="analytics-item">
                                <span>Session Duration:</span>
                                <span class="analytics-value">1h 30m</span>
                            </div>
                            <div class="analytics-item">
                                <span>Active Users:</span>
                                <span class="analytics-value"><%= lobby.lobby_members.length %>/5</span>
                            </div>
                            <div class="analytics-item">
                                <span>Problems Solved:</span>
                                <span class="analytics-value">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description and Permissions Section -->
                <div class="lobby-details">
                    <h3 class="section-title">Description</h3>
                    <div class="lobby-description"><%= lobby.description %></div>
                    
                    <% if current_user == lobby.owner %>
                        <div class="lobby-code-display">
                            <strong>Lobby Code:</strong> <span><%= lobby.lobby_code %></span>
                        </div>
                    <% end %>

                    <% if current_user == lobby.owner && lobby.lobby_members.length > 1 %>
                        <hr>
                        <h3 class="page-title">Manage Permissions</h3>

                        <%= form_with(model: lobby, url: update_all_lobby_permissions_path(lobby), method: :patch) do |form| %>
                            <table class="permissions-table">
                            <thead>
                                <tr>
                                <th>Participant</th>
                                <th>Can Draw</th>
                                <th>Can Edit Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% form.fields_for :lobby_members do |member_form| %>
                                <% next if member_form.object.user == lobby.owner %>
                                <tr>
                                    <td>
                                    <%= member_form.object.user.full_name %>
                                    <%= member_form.hidden_field :id %>
                                    </td>
                                    <td>
                                    <%= member_form.label :can_draw, "Can Draw", class: "visually-hidden" %>
                                    <%= member_form.check_box :can_draw %>
                                    </td>
                                    <td>
                                    <%= member_form.label :can_edit_notes, "Can Edit Notes", class: "visually-hidden" %>
                                    <%= member_form.check_box :can_edit_notes %>
                                    </td>
                                </tr>
                                <% end %>
                            </tbody>
                            </table>
                            <div class="lobby-actions">
                                <%= form.submit "Update All Permissions", class: "btn btn-primary" %>
                            </div>
                        <% end %>
                    <% end %>

                    <div class="lobby-actions">
                        <% if current_user == lobby.owner %>
                            <%= link_to "Destroy Lobby", lobby, 
                                        data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, 
                                        class: "btn btn-danger" %>
                        <% else %>
                            <%= button_to "Leave Lobby", leave_lobby_path(lobby), 
                                        method: :delete, 
                                        class: "btn btn-warning" %>
                        <% end %>
                        
                        <%= link_to "Back to Lobbies", lobbies_path, class: "btn btn-secondary" %>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>